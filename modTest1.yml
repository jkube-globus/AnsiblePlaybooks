# Description
# ===========
# Enable required repos and install Globus Connect Server

- name: Setup Globus 
  hosts: globus
  user: centos

  #shell: "if test nohup.out; then rm -f nohup.out;fi && nohup /usr/sbin/globus-connect-server login localhost &> nohup.out && grep https nohup.out"
  tasks:
        - name: Install PIP
          dnf:
                name: python3-pip
                state: latest
          become: True
          when: ansible_facts['os_family'] == 'RedHat' and ansible_facts['distribution_major_version'] == '8'

        - name: Install pexpect Python package
          pip:
            name: pexpect
          become: True

        - name: Retrieve Node Auth URL 
          shell: "nohup /usr/sbin/globus-connect-server login localhost &> nohup.out; grep https nohup.out"
          register: loginURL

        - name: Enter Globus Node Login 
          pause: 
            prompt: "Please paste the code generated from below:\n {{ loginURL.stdout }}"
          register: authCode

        - name: AuthCode check
          pause: 
            prompt: "Print our stuff here ? {{ authCode.user_input }}"

        - name: Globus Node Login 
          expect: 
                command: /usr/sbin/globus-connect-server login localhost
                responses: 
                        'Enter the resulting Authorization Code here:' : '{{ authCode.user_input }}'
          register: loginStatus

